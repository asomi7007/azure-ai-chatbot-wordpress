<?php
if (!defined('ABSPATH')) exit;

// Parsedown ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎìú (WordPress ÎÇ¥Ïû•)
if (!class_exists('Parsedown')) {
    require_once ABSPATH . 'wp-includes/class-parsedown.php';
}

// Í∞ÄÏù¥Îìú ÎßàÌÅ¨Îã§Ïö¥ ÌååÏùº Í≤ΩÎ°ú
$guide_file = AZURE_CHATBOT_PLUGIN_DIR . 'docs/USER_GUIDE.md';

// ÎßàÌÅ¨Îã§Ïö¥ ÌååÏùºÏù¥ ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ Í∞ÄÏù¥Îìú ÏÉùÏÑ±
if (!file_exists($guide_file)) {
    $guide_content = "Í∞ÄÏù¥Îìú ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.";
} else {
    $markdown_content = file_get_contents($guide_file);
    $parsedown = new Parsedown();
    $guide_content = $parsedown->text($markdown_content);
}
?>

<div class="wrap azure-chatbot-guide">
    <h1>
        <span class="dashicons dashicons-book"></span>
        Azure AI Chatbot ÏÇ¨Ïö© Í∞ÄÏù¥Îìú
    </h1>
    
    <div class="guide-container" style="display: flex; gap: 20px; align-items: flex-start;">
        <div class="guide-sidebar" style="position: sticky; top: 32px; flex: 0 0 280px; max-height: calc(100vh - 64px); overflow-y: auto;">
            <div class="postbox">
                <h2 class="hndle">üìë Î™©Ï∞®</h2>
                <div class="inside">
                    <nav id="guide-toc">
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            <li style="margin-bottom: 8px;">
                                <a href="#-ÏÜåÍ∞ú" style="text-decoration: none; color: #2271b1; display: block; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;" 
                                   onmouseover="this.style.background='#f0f0f1'" 
                                   onmouseout="this.style.background='transparent'"
                                   onclick="event.preventDefault(); scrollToSection('#-ÏÜåÍ∞ú');">
                                    ÏÜåÍ∞ú
                                </a>
                            </li>
                            <li style="margin-bottom: 8px;">
                                <a href="#-ÏÑ§Ïπò-Î∞©Î≤ï" style="text-decoration: none; color: #2271b1; display: block; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;" 
                                   onmouseover="this.style.background='#f0f0f1'" 
                                   onmouseout="this.style.background='transparent'"
                                   onclick="event.preventDefault(); scrollToSection('#-ÏÑ§Ïπò-Î∞©Î≤ï');">
                                    ÏÑ§Ïπò Î∞©Î≤ï
                                </a>
                            </li>
                            <li style="margin-bottom: 8px;">
                                <a href="#-ÏÑ§Ï†ï-Í∞ÄÏù¥Îìú" style="text-decoration: none; color: #2271b1; display: block; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;" 
                                   onmouseover="this.style.background='#f0f0f1'" 
                                   onmouseout="this.style.background='transparent'"
                                   onclick="event.preventDefault(); scrollToSection('#-ÏÑ§Ï†ï-Í∞ÄÏù¥Îìú');">
                                    ÏÑ§Ï†ï Í∞ÄÏù¥Îìú
                                </a>
                            </li>
                            <li style="margin-bottom: 8px;">
                                <a href="#-Ï£ºÏöî-Í∏∞Îä•" style="text-decoration: none; color: #2271b1; display: block; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;" 
                                   onmouseover="this.style.background='#f0f0f1'" 
                                   onmouseout="this.style.background='transparent'"
                                   onclick="event.preventDefault(); scrollToSection('#-Ï£ºÏöî-Í∏∞Îä•');">
                                    Ï£ºÏöî Í∏∞Îä•
                                </a>
                            </li>
                            <li style="margin-bottom: 8px;">
                                <a href="#-Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï" style="text-decoration: none; color: #2271b1; display: block; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;" 
                                   onmouseover="this.style.background='#f0f0f1'" 
                                   onmouseout="this.style.background='transparent'"
                                   onclick="event.preventDefault(); scrollToSection('#-Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï');">
                                    Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï
                                </a>
                            </li>
                            <li style="margin-bottom: 8px;">
                                <a href="#-Î¨∏Ï†ú-Ìï¥Í≤∞" style="text-decoration: none; color: #2271b1; display: block; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;" 
                                   onmouseover="this.style.background='#f0f0f1'" 
                                   onmouseout="this.style.background='transparent'"
                                   onclick="event.preventDefault(); scrollToSection('#-Î¨∏Ï†ú-Ìï¥Í≤∞');">
                                    Î¨∏Ï†ú Ìï¥Í≤∞
                                </a>
                            </li>
                            <li style="margin-bottom: 8px;">
                                <a href="#-ÏûêÏ£º-Î¨ªÎäî-ÏßàÎ¨∏" style="text-decoration: none; color: #2271b1; display: block; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;" 
                                   onmouseover="this.style.background='#f0f0f1'" 
                                   onmouseout="this.style.background='transparent'"
                                   onclick="event.preventDefault(); scrollToSection('#-ÏûêÏ£º-Î¨ªÎäî-ÏßàÎ¨∏');">
                                    ÏûêÏ£º Î¨ªÎäî ÏßàÎ¨∏
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
            
            <div class="postbox">
                <h2 class="hndle">üîß Îπ†Î•∏ ÏûëÏóÖ</h2>
                <div class="inside">
                    <ul class="quick-actions" style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 8px;">
                            <a href="admin.php?page=azure-ai-chatbot" class="button button-primary" style="width: 100%; text-align: center;">
                                ‚öôÔ∏è ÏÑ§Ï†ï ÌéòÏù¥ÏßÄ
                            </a>
                        </li>
                        <li style="margin-bottom: 8px;">
                            <a href="<?php echo admin_url('admin.php?page=azure-ai-chatbot-guide&action=edit'); ?>" class="button button-secondary" style="width: 100%; text-align: center;">
                                ‚úèÔ∏è Í∞ÄÏù¥Îìú Ìé∏Ïßë
                            </a>
                        </li>
                        <li style="margin-bottom: 8px;">
                            <a href="<?php echo admin_url('admin.php?page=azure-ai-chatbot-guide&action=download'); ?>" class="button button-secondary" style="width: 100%; text-align: center;">
                                ‚¨áÔ∏è Í∞ÄÏù¥Îìú Îã§Ïö¥Î°úÎìú
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="guide-content" style="flex: 1; min-width: 0;">
            <?php if (isset($_GET['action']) && $_GET['action'] === 'edit'): ?>
                <!-- Ìé∏Ïßë Î™®Îìú -->
                <div class="postbox">
                    <h2 class="hndle">‚úèÔ∏è Í∞ÄÏù¥Îìú Ìé∏Ïßë</h2>
                    <div class="inside">
                        <form method="post" action="">
                            <?php wp_nonce_field('azure_chatbot_edit_guide'); ?>
                            <p>
                                <label for="guide-editor"><strong>ÎßàÌÅ¨Îã§Ïö¥ Ìé∏Ïßë:</strong></label>
                            </p>
                            <textarea id="guide-editor" 
                                      name="guide_content" 
                                      rows="30" 
                                      style="width: 100%; font-family: monospace;"><?php echo esc_textarea(file_get_contents($guide_file)); ?></textarea>
                            <p class="description">
                                ÎßàÌÅ¨Îã§Ïö¥ Î¨∏Î≤ïÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ Í∞ÄÏù¥ÎìúÎ•º ÏûëÏÑ±Ìï† Ïàò ÏûàÏäµÎãàÎã§.
                                <a href="https://www.markdownguide.org/basic-syntax/" target="_blank">ÎßàÌÅ¨Îã§Ïö¥ Î¨∏Î≤ï Î≥¥Í∏∞</a>
                            </p>
                            <p>
                                <button type="submit" name="save_guide" class="button button-primary">
                                    üíæ Ï†ÄÏû•
                                </button>
                                <a href="admin.php?page=azure-ai-chatbot-guide" class="button button-secondary">
                                    Ï∑®ÏÜå
                                </a>
                            </p>
                        </form>
                    </div>
                </div>
            <?php else: ?>
                <!-- ÏùΩÍ∏∞ Î™®Îìú -->
                <div class="markdown-content">
                    <?php echo $guide_content; ?>
                </div>
            <?php endif; ?>
        </div>
    </div>
</div>

<script>
function scrollToSection(selector) {
    const element = document.querySelector(selector);
    if (element) {
        const offset = 100; // ÏÉÅÎã® Ïó¨Î∞±
        const elementPosition = element.getBoundingClientRect().top;
        const offsetPosition = elementPosition + window.pageYOffset - offset;
        
        window.scrollTo({
            top: offsetPosition,
            behavior: 'smooth'
        });
    }
}
</script>

<?php
// Í∞ÄÏù¥Îìú Ï†ÄÏû• Ï≤òÎ¶¨
if (isset($_POST['save_guide']) && check_admin_referer('azure_chatbot_edit_guide')) {
    $new_content = wp_unslash($_POST['guide_content']);
    
    if (file_put_contents($guide_file, $new_content) !== false) {
        echo '<div class="notice notice-success is-dismissible"><p>Í∞ÄÏù¥ÎìúÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.</p></div>';
        echo '<script>setTimeout(function(){ window.location.href = "admin.php?page=azure-ai-chatbot-guide"; }, 1500);</script>';
    } else {
        echo '<div class="notice notice-error is-dismissible"><p>Í∞ÄÏù¥Îìú Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÌååÏùº Í∂åÌïúÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.</p></div>';
    }
}

// Í∞ÄÏù¥Îìú Îã§Ïö¥Î°úÎìú Ï≤òÎ¶¨
if (isset($_GET['action']) && $_GET['action'] === 'download') {
    header('Content-Type: text/markdown');
    header('Content-Disposition: attachment; filename="azure-chatbot-guide.md"');
    readfile($guide_file);
    exit;
}
?>
